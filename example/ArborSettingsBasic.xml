<!-- Arbor Pandora settings xml file -->

<pandora>

    <!-- HELPER CLASS SETTINGS -->
    <IsMonitoringEnabled> true </IsMonitoringEnabled>
    <ShouldDisplayAlgorithmInfo> true </ShouldDisplayAlgorithmInfo>

    <!-- CaloHit helper settings -->
    <CaloHitHelper>
        <ShouldCalculateDensityWeight>true</ShouldCalculateDensityWeight>
        <ShouldCalculateSurroundingEnergy>true</ShouldCalculateSurroundingEnergy>
        
        <IsolationCaloHitMaxSeparation>     60    </IsolationCaloHitMaxSeparation>
        <IsolationNLayers>                   2    </IsolationNLayers>
        <IsolationCutDistanceFine>          25.0  </IsolationCutDistanceFine>
        <IsolationCutDistanceCoarse>        30.0  </IsolationCutDistanceCoarse>
        <IsolationMaxNearbyHits>             2    </IsolationMaxNearbyHits>
    </CaloHitHelper>

    <!-- ARBOR PANDORA ALGORITHM SETTINGS -->

    <!-- Select tracks and hits to use for clustering -->
    <algorithm type = "EventPreparation"/>
    
    
    <!-- Create objects to cluster before starting anything -->
    <algorithm type="ObjectCreationParent">
      <algorithm type="SimpleObjectCreation" description="ObjectFormation">
        <ShouldUseOnlyCaloHitsForObjectsInEcal> true </ShouldUseOnlyCaloHitsForObjectsInEcal>
        <ShouldUseReadoutLayerInEcal> false </ShouldUseReadoutLayerInEcal>
        <ShouldUseOnlyCaloHitsForObjectsInHcal> false </ShouldUseOnlyCaloHitsForObjectsInHcal>
        <MaximumSizeForClusterSplittingInHcal> 4 </MaximumSizeForClusterSplittingInHcal>
        <IntraLayerMaxDistanceInHcal> 11.f </IntraLayerMaxDistanceInHcal>
        <ShouldUseReadoutLayerInHcal> false </ShouldUseReadoutLayerInHcal>
        <ShouldSplitClusterInSingleCaloHitClustersInHcal> true </ShouldSplitClusterInSingleCaloHitClustersInHcal>
      </algorithm>
      <ObjectListName>   InputObjects   </ObjectListName>
      <ReplaceCurrentObjectList>  true  </ReplaceCurrentObjectList>
    </algorithm>
    
    
    <!-- Tag some objects as isolated -->
    <algorithm type = "IsolationTagging">
       <MaxNObjectsInSamePseudoLayer> 3 </MaxNObjectsInSamePseudoLayer>
       <MaxNObjects> 1 </MaxNObjects> 
       <MaxNeighborDistance> 80.f </MaxNeighborDistance>
       <MaxIntraLayerNeighborDistance> 18.f </MaxIntraLayerNeighborDistance>
    </algorithm>
    
    
    <!-- Create clusters by connecting objects in an oriented tree topology -->
    <algorithm type="ConnectorClusteringParent">
    
      <!-- Create connectors and clean them multiple time if needed -->
      <algorithm type="ConnectorParent" description="ConnectorIteration">
      
        <connectorAlgorithms>
          <!-- Seed connectors everywhere in neighborhood -->
          <algorithm type="ConnectorSeeding">
            <MaxForwardPseudoLayer> 3 </MaxForwardPseudoLayer>
            <EcalConnectionDistance> 25.0 </EcalConnectionDistance>
            <HcalConnectionDistance> 85.0 </HcalConnectionDistance>
            <AllowForwardConnectionForIsolatedObjects> false </AllowForwardConnectionForIsolatedObjects>
            <UseOnlyTrackSeedingStrategy> false </UseOnlyTrackSeedingStrategy>            
          </algorithm>
          
          <!-- Clean connector lists using the kappa parameter, in order to create a tree structure -->
          <algorithm type="KappaConnectorCleaning">
            <BackwardConnectorWeight> 10 </BackwardConnectorWeight>    
            <ForwardConnectorWeight> 0.0001 </ForwardConnectorWeight>
            <OrderParameterAnglePower> 1 </OrderParameterAnglePower>
            <OrderParameterDistancePower> 5 </OrderParameterDistancePower>
            <ReferenceDirectionDepth> 1 </ReferenceDirectionDepth>
            <ReferenceDirectionMaximumForwardLayer> 5 </ReferenceDirectionMaximumForwardLayer>
          </algorithm>
        </connectorAlgorithms>
        
      </algorithm>
      
      <!-- Create trees from connected objects -->
      <algorithm type="TreeClustering" description="ClusterFormation"/>
      
      <!-- Make topological associations between trees and clusters -->
      <algorithm type="TopologicalAssociationParent" description="TopologicalAssociation">
        <associationAlgorithms>
        
          <!-- Create track to cluster associations -->
          <algorithm type = "TopologicalTrackAssociation">
            <ShouldMergeChargedTrees> true </ShouldMergeChargedTrees>
            <TrackToClusterDistanceCut> 45.f </TrackToClusterDistanceCut>
            <TrackToClusterNLayersCut> 2 </TrackToClusterNLayersCut>
          </algorithm>
          
          <!-- Merge neutral trees that have close-by seeds -->
          <algorithm type = "NeutralTreeMerging">
            <UseClustersWithTrackAssociation> true </UseClustersWithTrackAssociation>
            <SeedSeparationDistance> 25.0 </SeedSeparationDistance>
          </algorithm>
          
          <!-- Associate small neutral fragments to their closest cluster -->
          <algorithm type = "SmallNeutralFragmentMerging">
            <MaximumDaughterNObject> 10 </MaximumDaughterNObject>
            <LargeDistanceCut> 1000.f </LargeDistanceCut>
            <ShouldUseDistanceToCentroid> false </ShouldUseDistanceToCentroid>
          </algorithm>
          
        </associationAlgorithms>
      
      </algorithm>
      
      <ClusterListName>            ArborClusters    </ClusterListName>
      <ReplaceCurrentClusterList>  true             </ReplaceCurrentClusterList>
    </algorithm>
    
    
    <!-- ARBOR-to-PANDORA cluster conversion -->
    <algorithm type = "ClusteringParent">
      <algorithm type = "ArborClusterConverter" description = "ClusterFormation">
        <ArborClusterListNames>    ArborClusters    </ArborClusterListNames>
      </algorithm>
      <ClusterListName>            OutputClusters    </ClusterListName>
      <ReplaceCurrentClusterList>  true             </ReplaceCurrentClusterList>
    </algorithm>


    <!-- EVE Monitoring -->
    <algorithm type = "VisualMonitoring" description = "display all">
       <DisplayEvent>true</DisplayEvent>
       
       <ShowMCParticles>false</ShowMCParticles>
       <ShowCurrentCaloHits>true</ShowCurrentCaloHits>
       <ShowCurrentTracks>true</ShowCurrentTracks> 
       <ShowCurrentClusters>true</ShowCurrentClusters> 
       <ShowCurrentPfos>false</ShowCurrentPfos>
       <HitColors> iterate </HitColors>
       <ShowOnlyAvailable>false</ShowOnlyAvailable>
       
       <TransparencyThresholdE>-1.</TransparencyThresholdE>
       <EnergyScaleThresholdE>1.</EnergyScaleThresholdE> 
       <BlackBackground>true</BlackBackground>
       <ShowDetector>false</ShowDetector>
          
    </algorithm>
    
    
    
</pandora>
